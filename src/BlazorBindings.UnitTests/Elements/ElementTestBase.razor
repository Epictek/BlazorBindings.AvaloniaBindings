@using BlazorBindings.AvaloniaBindings.Elements.Handlers
@using Microsoft.AspNetCore.Components.Rendering;
@using System.Reflection;
@using System.Runtime.ExceptionServices;

@implements IHandleEvent

@code {
    public ElementTestBase()
    {
        // Avalonia.Application.Current = new TestApplication();
        // _application = TestApplication.Create();
    }

    private TestApplication _application;
    // private AC.Window _window;
    private TestBlazorBindingsRenderer _renderer;
    protected RenderFragmentComponent _renderedComponent;

    protected async Task<T> Render<T>(RenderFragment renderFragment)
    {
        _application ??= (TestApplication)Avalonia.Application.Current ??
            throw new InvalidOperationException("Application not initialized - did you use [AvaloniaTest]?");
        _renderer ??= (TestBlazorBindingsRenderer)TestBlazorBindingsRenderer.Get(_application);


        Avalonia.Threading.Dispatcher.UIThread.VerifyAccess();
        // _window = new AC.Window
        //     {
        //         Width = 100,
        //         Height = 100
        //     };
        // _application.Window = _window;

        var container = new ApplicationHandler(_application);
        _renderedComponent = await _renderer.AddComponent<RenderFragmentComponent>(container, new Dictionary<string, object>
            {
                ["RenderFragment"] = renderFragment
            });

        // return (T)container.Elements[0];
        return (T)_application.Window.Content;
    }

    protected new void StateHasChanged()
    {
        _renderedComponent?.StateHasChanged();
        ThrowOnException();
    }

    protected void ThrowOnException()
    {
        _application ??= (TestApplication)Avalonia.Application.Current ??
            throw new InvalidOperationException("Application not initialized - did you use [AvaloniaTest]?");
        _renderer ??= (TestBlazorBindingsRenderer)TestBlazorBindingsRenderer.Get(_application);

        if (_renderer.Exceptions.Count > 0)
        {
            ExceptionDispatchInfo.Throw(_renderer.Exceptions[0]);
        }
    }

    Task IHandleEvent.HandleEventAsync(EventCallbackWorkItem callback, object arg)
    {
        var task = (_renderedComponent as IHandleEvent)?.HandleEventAsync(callback, arg);
        ThrowOnException();
        return task ?? Task.CompletedTask;
    }

    protected class RenderFragmentComponent : ComponentBase
    {
        [Parameter] public RenderFragment RenderFragment { get; set; }

        protected override void BuildRenderTree(RenderTreeBuilder builder)
        {
            RenderFragment(builder);
        }

        public new void StateHasChanged()
        {
            base.StateHasChanged();
        }
    }
}
